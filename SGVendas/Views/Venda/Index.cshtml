@{
    ViewData["Title"] = "Venda";
}

<h2>Nova Venda</h2>

<hr />

<!-- CABEÇALHO DA VENDA -->
<div class="row mb-3">

    <div class="col-md-4">
        <label>Vendedor</label>
        <input type="text" id="txtVendedor" class="form-control" placeholder="Buscar vendedor..." />
        <input type="hidden" id="VendedorID" />
    </div>

    <div class="col-md-4">
        <label>Cliente</label>
        <input type="text" id="txtCliente" class="form-control" placeholder="Buscar cliente..." />
        <input type="hidden" id="ClienteID" />
    </div>

    <div class="col-md-4">
        <label>Data da Venda</label>
        <input type="date" id="dataVenda" class="form-control"
               value="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

</div>

<hr />

<!-- INCLUSÃO DE PRODUTOS -->
<h4>Produtos</h4>

<div class="row mb-3">

    <div class="col-md-5">
        <label>Produto</label>
        <input type="text" id="txtProduto" class="form-control" placeholder="Buscar produto..." />
        <input type="hidden" id="ProdutoID" />
    </div>

    <div class="col-md-2">
        <label>Quantidade</label>
        <input type="number" id="Quantidade" class="form-control" value="1" min="1" />
    </div>

    <div class="col-md-3">
        <label>Preço Unitário</label>
        <input type="text" id="PrecoUnitario" class="form-control" readonly />
    </div>

    <div class="col-md-2">
        <label>&nbsp;</label>
        <button id="btnAdicionar" class="btn btn-success w-100">
            Adicionar
        </button>
    </div>

</div>

<hr />

<!-- GRID DE ITENS -->
<table class="table table-bordered" id="gridItens">
    <thead class="table-light">
        <tr>
            <th>Produto</th>
            <th style="width: 100px;">Qtd</th>
            <th style="width: 120px;">Preço</th>
            <th style="width: 120px;">Subtotal</th>
            <th style="width: 80px;">Ação</th>
        </tr>
    </thead>
    <tbody>
        <!-- itens adicionados via jQuery -->
    </tbody>
</table>

<hr />

<!-- TOTAIS -->
<div class="row">
    <div class="col-md-4 offset-md-8 text-end">
        <h4>
            Total: R$
            <span id="TotalVenda">0,00</span>
        </h4>

        <button id="btnFinalizar" class="btn btn-primary mt-2">
            Finalizar Venda
        </button>
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
@section Scripts {

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- jQuery UI (Autocomplete) -->
    <link rel="stylesheet"
          href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        $(function () {

            // =========================
            // AUTOCOMPLETE CLIENTE
            // =========================
            $("#txtCliente").autocomplete({
                source: function (request, response) {
                    $.getJSON("/api/clientes/buscar", {
                        termo: request.term
                    }, response);
                },
                select: function (event, ui) {
                    $("#ClienteID").val(ui.item.id);
                },
                minLength: 2
            });

            // =========================
            // AUTOCOMPLETE VENDEDOR
            // =========================
            $("#txtVendedor").autocomplete({
                source: function (request, response) {
                    $.getJSON("/api/clientes/vendedores", {
                        termo: request.term
                    }, response);
                },
                select: function (event, ui) {
                    $("#VendedorID").val(ui.item.id);
                },
                minLength: 2
            });

            // =========================
            // VARIÁVEIS DA VENDA
            // =========================
            let itens = [];

            // =========================
            // ADICIONAR ITEM
            // =========================
            $("#btnAdicionar").click(function () {

                const produtoId = $("#ProdutoID").val();
                const produtoNome = $("#txtProduto").val();
                const quantidade = parseInt($("#Quantidade").val());
                const preco = parseFloat($("#PrecoUnitario").val().replace(",", "."));

                if (!produtoId || quantidade <= 0 || isNaN(preco)) {
                    alert("Informe um produto válido.");
                    return;
                }

                const subtotal = quantidade * preco;

                itens.push({
                    produtoId,
                    produtoNome,
                    quantidade,
                    preco,
                    subtotal
                });

                atualizarGrid();
                limparProduto();
            });

            // =========================
            // ATUALIZAR GRID
            // =========================
            function atualizarGrid() {
                let tbody = $("#gridItens tbody");
                tbody.empty();

                let total = 0;

                $.each(itens, function (index, item) {
                    total += item.subtotal;

                    tbody.append(`
                        <tr>
                            <td>${item.produtoNome}</td>
                            <td>${item.quantidade}</td>
                            <td>${item.preco.toFixed(2)}</td>
                            <td>${item.subtotal.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                    onclick="removerItem(${index})">
                                    X
                                </button>
                            </td>
                        </tr>
                    `);
                });

                $("#TotalVenda").text(total.toFixed(2));
            }

            // =========================
            // LIMPAR PRODUTO
            // =========================
            function limparProduto() {
                $("#ProdutoID").val("");
                $("#txtProduto").val("");
                $("#Quantidade").val(1);
                $("#PrecoUnitario").val("");
            }

            // =========================
            // REMOVER ITEM
            // =========================
            window.removerItem = function (index) {
                itens.splice(index, 1);
                atualizarGrid();
            };

        });
    </script>
}
