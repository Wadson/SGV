@{
    ViewData["Title"] = "Venda";
}

<h2>Nova Venda</h2>

<hr />

<!-- ========================================================= -->
<!-- CABEÇALHO DA VENDA -->
<!-- ========================================================= -->
<div class="row mb-3">

    <div class="col-md-4">
        <label>Vendedor</label>
        <input type="text" id="txtVendedor" class="form-control" placeholder="Buscar vendedor..." />
        <input type="hidden" id="VendedorID" />
    </div>

    <div class="col-md-4">
        <label>Cliente</label>
        <input type="text" id="txtCliente" class="form-control" placeholder="Buscar cliente..." />
        <input type="hidden" id="ClienteID" />
    </div>

    <div class="col-md-4">
        <label>Data da Venda</label>
        <input type="date" id="dataVenda" class="form-control"
               value="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

</div>

<hr />

<!-- ========================================================= -->
<!-- PRODUTOS -->
<!-- ========================================================= -->
<h4>Produtos</h4>

<div class="row mb-3">

    <div class="col-md-5">
        <label>Produto</label>
        <input type="text" id="txtProduto" class="form-control" placeholder="Buscar produto..." />
        <input type="hidden" id="ProdutoID" />
    </div>

    <div class="col-md-2">
        <label>Quantidade</label>
        <input type="number" id="Quantidade" class="form-control" value="1" min="1" />
    </div>

    <div class="col-md-3">
        <label>Preço Unitário</label>
        <input type="text" id="PrecoUnitario" class="form-control" readonly />
    </div>

    <div class="col-md-2">
        <label>&nbsp;</label>
        <button id="btnAdicionar" class="btn btn-success w-100">Adicionar</button>
    </div>

</div>

<hr />

<!-- ========================================================= -->
<!-- GRID DE ITENS -->
<!-- ========================================================= -->
<table class="table table-bordered" id="gridItens">
    <thead class="table-light">
        <tr>
            <th>Produto</th>
            <th width="100">Qtd</th>
            <th width="120">Preço</th>
            <th width="120">Subtotal</th>
            <th width="80">Ação</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<hr />

<!-- ========================================================= -->
<!-- TOTAL -->
<!-- ========================================================= -->
<div class="row">
    <div class="col-md-4 offset-md-8 text-end">
        <h4>Total: R$ <span id="TotalVenda">0,00</span></h4>
        <button id="btnFinalizar" class="btn btn-primary mt-2">Finalizar Venda</button>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL PAGAMENTO -->
<!-- ========================================================= -->
<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Forma de Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>Forma de Pagamento</label>
                        <select id="FormaPgtoID" class="form-control"></select>
                    </div>

                    <div class="col-md-6">
                        <label>Tipo</label>
                        <select id="TipoPagamento" class="form-control">
                            <option value="avista">À Vista</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>
                </div>

                <div id="areaParcelas" style="display:none;">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Nº Parcelas</label>
                            <input type="number" id="NumeroParcelas" class="form-control" value="1" min="1" />
                        </div>

                        <div class="col-md-6">
                            <label>1º Vencimento</label>
                            <input type="date" id="DataPrimeiroVencimento"
                                   class="form-control"
                                   value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")" />
                        </div>
                    </div>

                    <table class="table table-bordered" id="gridParcelas">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarPagamento" class="btn btn-success">Confirmar</button>
            </div>

        </div>
    </div>
</div>

<!-- ========================================================= -->
<!-- SCRIPTS -->
<!-- ========================================================= -->
@section Scripts {

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <style>
        .ui-autocomplete {
            z-index: 1055 !important;
        }
    </style>

    <script>

        $(function () {

            let itens = [];

            // ================= AUTOCOMPLETE CLIENTE =================
                  $("#txtCliente").autocomplete({
            source: function (request, response) {
                $.getJSON("/api/clientes/buscar", { termo: request.term }, response);
            },
            select: function (event, ui) {
                $("#ClienteID").val(ui.item.id);
                $("#txtCliente").val(ui.item.label);
                return false;
            },
            minLength: 2
        });


            // ================= AUTOCOMPLETE VENDEDOR =================
            $("#txtVendedor").autocomplete({
                source: (r, s) => $.getJSON("/api/clientes/vendedores", { termo: r.term }, s),
                select: (_, ui) => $("#VendedorID").val(ui.item.id),
                minLength: 2
            });

            // ================= AUTOCOMPLETE PRODUTO =================
            $("#txtProduto").autocomplete({
                source: (r, s) => $.getJSON("/api/produtos/buscar", { termo: r.term }, s),
                select: (_, ui) => {
                    $("#ProdutoID").val(ui.item.id);
                    $("#txtProduto").val(ui.item.label);
                    $("#PrecoUnitario").val(ui.item.preco.toFixed(2));
                    $("#txtProduto").data("estoque", ui.item.estoque);
                    return false;
                },
                minLength: 2
            });

            // ================= ADICIONAR ITEM =================
            $("#btnAdicionar").click(() => {

                const id = +$("#ProdutoID").val();
                const nome = $("#txtProduto").val();
                const qtd = +$("#Quantidade").val();
                const preco = +$("#PrecoUnitario").val();
                const estoque = +$("#txtProduto").data("estoque");

                if (!id || qtd <= 0 || qtd > estoque) {
                    alert("Produto inválido ou estoque insuficiente.");
                    return;
                }

                const existente = itens.find(i => i.produtoId === id);
                if (existente) {
                    existente.quantidade += qtd;
                    existente.subtotal = existente.quantidade * existente.preco;
                } else {
                    itens.push({ produtoId: id, produtoNome: nome, quantidade: qtd, preco, subtotal: qtd * preco });
                }

                atualizarGrid();
            });

            function atualizarGrid() {
                let total = 0;
                $("#gridItens tbody").html(itens.map((i, idx) => {
                    total += i.subtotal;
                    return `<tr>
                        <td>${i.produtoNome}</td>
                        <td>${i.quantidade}</td>
                        <td>R$ ${i.preco.toFixed(2)}</td>
                        <td>R$ ${i.subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removerItem(${idx})">X</button></td>
                    </tr>`;
                }));
                $("#TotalVenda").text(total.toFixed(2));
            }

            window.removerItem = i => { itens.splice(i,1); atualizarGrid(); };


                    // =====================================================
        // BOTÃO FINALIZAR (ABRE MODAL)
        // =====================================================
        $("#btnFinalizar").click(function () {

            if (!$("#ClienteID").val()) {
                alert("Selecione um cliente válido da lista.");
                return;
            }

            if (!$("#VendedorID").val()) {
                alert("Selecione um vendedor válido da lista.");
                return;
            }

            if (itens.length === 0) {
                alert("Adicione ao menos um produto.");
                return;
            }

            $("#modalPagamento").modal("show");
        });

        // =====================================================
        // MOSTRA / ESCONDE PARCELAS
        // =====================================================
        $("#TipoPagamento").change(function () {

            if ($(this).val() === "parcelado") {
                gerarParcelas();
                $("#areaParcelas").show();
            } else {
                $("#areaParcelas").hide();
                $("#gridParcelas tbody").empty();
            }
        });

        // =====================================================
        // GERA PARCELAS AUTOMATICAMENTE
        // =====================================================
        function gerarParcelas() {

            const numeroParcelas = parseInt($("#NumeroParcelas").val() || 1);
            const total = parseFloat($("#TotalVenda").text().replace(",", "."));
            const valorParcela = (total / numeroParcelas).toFixed(2);

            const tbody = $("#gridParcelas tbody");
            tbody.empty();

            for (let i = 1; i <= numeroParcelas; i++) {

                const vencimento = new Date();
                vencimento.setMonth(vencimento.getMonth() + i);

                tbody.append(`
                    <tr>
                        <td>${i}</td>
                        <td>${vencimento.toISOString().split("T")[0]}</td>
                        <td>${valorParcela}</td>
                    </tr>
                `);
            }
        }

        // =====================================================
        // CONFIRMAR PAGAMENTO (GRAVA TUDO)
        // =====================================================
        $("#btnConfirmarPagamento").click(function () {

                 if (!$("#FormaPgtoID").val()) {
            alert("Selecione a forma de pagamento.");
            return;
        }

                   const venda = {
            clienteID: parseInt($("#ClienteID").val()),
            vendedorID: parseInt($("#VendedorID").val()),
            formaPgtoID: parseInt($("#FormaPgtoID").val()),
            observacoes: "Venda Web",

            itens: itens.map(i => ({
                produtoID: i.produtoId,
                quantidade: i.quantidade,
                precoUnitario: i.preco
            })),

            parcelas: [] };


            // Parcelas
                   if ($("#TipoPagamento").val() === "parcelado") {
            $("#gridParcelas tbody tr").each(function () {
                venda.parcelas.push({
                    numero: parseInt($(this).find("td:eq(0)").text()),
                    dataVencimento: $(this).find("td:eq(1)").text(),
                    valor: parseFloat($(this).find("td:eq(2)").text())
                });
            });
        }

                $.ajax({
            url: "/api/vendas/finalizar",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(venda),
            success: function (res) {
                alert("Venda realizada com sucesso! ID: " + res.vendaId);
                location.reload();
            },
            error: function (xhr) {
                console.error(xhr);
                alert(
                    "ERRO AO FINALIZAR:\n\n" +
                    (xhr.responseJSON?.erro || xhr.responseText || "Erro desconhecido")
                );
            }
        });

        });

            // ================= PAGAMENTO =================
            $("#btnFinalizar").click(() => $("#modalPagamento").modal("show"));

            $.getJSON("/api/formas-pagamento", data => {
                $("#FormaPgtoID").html('<option value="">Selecione</option>');
                data.forEach(f => $("#FormaPgtoID").append(`<option value="${f.id}">${f.descricao}</option>`));
            });

            $("#TipoPagamento").change(() => {
                $("#areaParcelas").toggle($("#TipoPagamento").val() === "parcelado");
                gerarParcelas();
            });

            $("#NumeroParcelas, #DataPrimeiroVencimento").on("change", gerarParcelas);

            function gerarParcelas() {
                const qtd = +$("#NumeroParcelas").val();
                const total = +$("#TotalVenda").text();
                let data = new Date($("#DataPrimeiroVencimento").val());
                const valor = (total / qtd).toFixed(2);
                $("#gridParcelas tbody").empty();
                for (let i = 1; i <= qtd; i++) {
                    $("#gridParcelas tbody").append(`<tr><td>${i}</td><td>${data.toISOString().split("T")[0]}</td><td>${valor}</td></tr>`);
                    data.setMonth(data.getMonth()+1);
                }
            }

        });
    </script>
}
