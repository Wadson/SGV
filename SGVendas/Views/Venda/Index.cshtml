@{
    ViewData["Title"] = "Venda";
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --sgvendas-primary: #2c3e50;
            --sgvendas-secondary: #3498db;
            --sgvendas-success: #27ae60;
            --sgvendas-warning: #f39c12;
            --sgvendas-info: #1abc9c;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-venda {
            background: linear-gradient(135deg, var(--sgvendas-primary) 0%, var(--sgvendas-secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-title {
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .card-venda {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header-venda {
            background-color: rgba(52, 152, 219, 0.1);
            border-bottom: 2px solid #3498db;
            padding: 1.25rem;
            font-weight: 600;
            font-size: 1.2rem;
            color: #2c3e50;
        }

        .card-body-venda {
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }

        .btn-custom {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success-custom {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .table-custom thead {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .table-custom th {
            border: none;
            padding: 1rem;
            font-weight: 600;
        }

        .table-custom td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }

        .table-custom tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .badge-estoque {
            background-color: #e9ecef;
            color: #495057;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .total-venda {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);
        }

        .total-venda h4 {
            font-weight: 700;
            margin: 0;
        }

        .total-valor {
            font-size: 2.5rem;
            font-weight: 800;
        }

        .modal-content {
            border-radius: 15px;
            overflow: hidden;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-bottom: none;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 1.5rem;
        }

        .input-group-icon {
            position: relative;
        }

        .input-group-icon input {
            padding-left: 2.5rem;
        }

        .input-group-icon i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 3;
        }

        .separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 2rem 0;
            color: #6c757d;
            font-weight: 600;
        }

        .separator::before,
        .separator::after {
            content: '';
            flex: 1;
            border-bottom: 2px solid #dee2e6;
        }

        .separator:not(:empty)::before {
            margin-right: 1rem;
        }

        .separator:not(:empty)::after {
            margin-left: 1rem;
        }

        /* Responsividade */
        @Html.Raw("@media (max-width: 768px) { .header-title { font-size: 1.5rem; } .total-valor { font-size: 2rem; } .card-body-venda { padding: 1rem; } }")
    </style>
</head>
<body>
    <div class="header-venda">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="header-title">Nova Venda</h1>
                    <p class="header-subtitle">Sistema SGVendas | Registro de vendas</p>
                </div>
                <div class="d-none d-md-block">
                    <span class="badge bg-light text-dark fs-6 p-2">
                        <i class="bi bi-cart-check me-1"></i> Venda
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ========================================================= -->
        <!-- CABEÇALHO DA VENDA -->
        <!-- ========================================================= -->
        <div class="card card-venda">
            <div class="card-header card-header-venda">
                <i class="bi bi-person-lines-fill me-2"></i> Dados da Venda
            </div>
            <div class="card-body card-body-venda">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Vendedor</label>
                        <div class="input-group-icon">
                            <i class="bi bi-person-badge"></i>
                            <input type="text" id="txtVendedor" class="form-control" placeholder="Buscar vendedor..." />
                        </div>
                        <input type="hidden" id="VendedorID" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Cliente</label>
                        <div class="input-group-icon">
                            <i class="bi bi-person"></i>
                            <input type="text" id="txtCliente" class="form-control" placeholder="Buscar cliente..." />
                        </div>
                        <input type="hidden" id="ClienteID" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Data da Venda</label>
                        <div class="input-group-icon">
                            <i class="bi bi-calendar"></i>
                            <input type="date" id="dataVenda" class="form-control"
                                   value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- ADIÇÃO DE PRODUTOS -->
        <!-- ========================================================= -->
        <div class="card card-venda">
            <div class="card-header card-header-venda">
                <i class="bi bi-cart-plus me-2"></i> Adicionar Produtos
            </div>
            <div class="card-body card-body-venda">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label">Produto</label>
                        <div class="input-group-icon">
                            <i class="bi bi-box-seam"></i>
                            <input type="text" id="txtProduto" class="form-control" placeholder="Buscar produto..." />
                        </div>
                        <input type="hidden" id="ProdutoID" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="Quantidade" class="form-control" value="1" min="1" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Preço Unitário</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" id="PrecoUnitario" class="form-control" readonly />
                        </div>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button id="btnAdicionar" class="btn btn-success-custom btn-custom w-100">
                            <i class="bi bi-plus-circle me-1"></i> Adicionar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- GRID DE ITENS -->
        <!-- ========================================================= -->
        <div class="card card-venda">
            <div class="card-header card-header-venda">
                <i class="bi bi-list-check me-2"></i> Itens da Venda
            </div>
            <div class="card-body card-body-venda">
                <div class="table-responsive">
                    <table class="table table-custom table-hover" id="gridItens">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th width="100" class="text-center">Qtd</th>
                                <th width="120" class="text-end">Preço Unit.</th>
                                <th width="120" class="text-end">Subtotal</th>
                                <th width="80" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="alert alert-light text-center mt-3" id="emptyCart" style="display: none;">
                    <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-2">Nenhum produto adicionado</h5>
                    <p class="text-muted">Adicione produtos à venda para continuar</p>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- TOTAL E FINALIZAÇÃO -->
        <!-- ========================================================= -->
        <div class="card card-venda">
            <div class="card-body card-body-venda">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-0 text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            Total de itens: <span id="totalItens" class="fw-bold">0</span>
                        </h5>
                    </div>
                    <div class="col-md-4">
                        <div class="total-venda text-center">
                            <h5 class="mb-2">Total da Venda</h5>
                            <div class="total-valor">R$ <span id="TotalVenda">0,00</span></div>
                            <button id="btnFinalizar" class="btn btn-light btn-custom mt-3 w-100">
                                <i class="bi bi-check-circle me-2"></i> Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- MODAL PAGAMENTO -->
    <!-- ========================================================= -->
    <div class="modal fade" id="modalPagamento" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i> Forma de Pagamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Forma de Pagamento</label>
                            <select id="FormaPgtoID" class="form-select">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Pagamento</label>
                            <select id="TipoPagamento" class="form-select">
                                <option value="avista">À Vista</option>
                                <option value="parcelado">Parcelado</option>
                            </select>
                        </div>
                    </div>

                    <div id="areaParcelas" style="display:none;">
                        <div class="separator">Configuração de Parcelas</div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Número de Parcelas</label>
                                <input type="number" id="NumeroParcelas" class="form-control" value="1" min="1" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primeiro Vencimento</label>
                                <input type="date" id="DataPrimeiroVencimento"
                                       class="form-control"
                                       value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")" />
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-custom" id="gridParcelas">
                                <thead>
                                    <tr>
                                        <th width="60">#</th>
                                        <th>Vencimento</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Valor total: <strong>R$ <span id="modalTotal">0,00</span></strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-custom" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                    <button id="btnConfirmarPagamento" class="btn btn-success-custom btn-custom">
                        <i class="bi bi-check-circle me-1"></i> Confirmar Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- SCRIPTS (MANTIDOS EXATAMENTE COMO ESTAVAM) -->
    <!-- ========================================================= -->
    @section Scripts {
        <!-- ========================= -->
        <!-- DEPENDÊNCIAS -->
        <!-- ========================= -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <link rel="stylesheet"
              href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

        <style>
            .ui-autocomplete {
                z-index: 1055 !important;
                max-height: 200px;
                overflow-y: auto;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .ui-menu-item {
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .ui-menu-item:last-child {
                border-bottom: none;
            }
            
            .ui-state-active {
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
                color: white !important;
                border: none !important;
            }
        </style>

        <script>
            $(function () {

                // =====================================================
                // ESTADO GLOBAL DA VENDA
                // =====================================================
                let itens = [];

                // =====================================================
                // AUTOCOMPLETE CLIENTE
                // =====================================================
                $("#txtCliente").autocomplete({
                    source: function (request, response) {
                        $.getJSON("/api/clientes/buscar", { termo: request.term }, response);
                    },
                    select: function (event, ui) {
                        $("#ClienteID").val(ui.item.id);
                        $("#txtCliente").val(ui.item.label);
                        return false;
                    },
                    minLength: 2
                });

                // =====================================================
                // AUTOCOMPLETE VENDEDOR
                // =====================================================
                $("#txtVendedor").autocomplete({
                    source: function (request, response) {
                        $.getJSON("/api/clientes/vendedores", { termo: request.term }, response);
                    },
                    select: function (event, ui) {
                        $("#VendedorID").val(ui.item.id);
                        $("#txtVendedor").val(ui.item.label);
                        return false;
                    },
                    minLength: 2
                });

                // =====================================================
                // AUTOCOMPLETE PRODUTO
                // =====================================================
                $("#txtProduto").autocomplete({
                    source: function (request, response) {
                        $.getJSON("/api/produto/buscar", { termo: request.term }, response);
                    },
                    select: function (event, ui) {

                        $("#ProdutoID").val(ui.item.id);
                        $("#txtProduto").val(ui.item.label);
                        $("#PrecoUnitario").val(ui.item.preco.toFixed(2));
                        $("#txtProduto").data("estoque", ui.item.estoque);

                        return false;
                    },
                    minLength: 2
                });

                // =====================================================
                // ADICIONAR ITEM AO GRID
                // =====================================================
                $("#btnAdicionar").click(function () {

                    const produtoId = +$("#ProdutoID").val();
                    const produtoNome = $("#txtProduto").val();
                    const quantidade = +$("#Quantidade").val();
                    const preco = +$("#PrecoUnitario").val();
                    const estoque = +$("#txtProduto").data("estoque");

                    if (!produtoId || quantidade <= 0 || quantidade > estoque) {
                        alert("Produto inválido ou estoque insuficiente.");
                        return;
                    }

                    const itemExistente = itens.find(i => i.produtoId === produtoId);

                    if (itemExistente) {
                        itemExistente.quantidade += quantidade;
                        itemExistente.subtotal =
                            itemExistente.quantidade * itemExistente.preco;
                    } else {
                        itens.push({
                            produtoId,
                            produtoNome,
                            quantidade,
                            preco,
                            subtotal: quantidade * preco
                        });
                    }

                    atualizarGrid();
                    limparProdutoEFocar();
                });

                // =====================================================
                // ATUALIZA GRID DE ITENS + TOTAL
                // =====================================================
                function atualizarGrid() {

                    let total = 0;
                    const tbody = $("#gridItens tbody");
                    tbody.empty();

                    itens.forEach((item, index) => {

                        total += item.subtotal;

                        tbody.append(`
                            <tr>
                                <td>${item.produtoNome}</td>
                                <td class="text-center">${item.quantidade}</td>
                                <td class="text-end">R$ ${item.preco.toFixed(2)}</td>
                                <td class="text-end">R$ ${item.subtotal.toFixed(2)}</td>
                                <td class="text-center">
                                    <button class="btn btn-danger-custom btn-sm btn-custom"
                                        onclick="removerItem(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `);
                    });

                    $("#TotalVenda").text(total.toFixed(2));
                    $("#modalTotal").text(total.toFixed(2));
                    $("#totalItens").text(itens.length);
                    
                    // Mostra/oculta mensagem de carrinho vazio
                    if (itens.length === 0) {
                        $("#emptyCart").show();
                    } else {
                        $("#emptyCart").hide();
                    }
                }

                // =====================================================
                // REMOVER ITEM
                // =====================================================
                window.removerItem = function (index) {
                    itens.splice(index, 1);
                    atualizarGrid();
                };

                // =====================================================
                // LIMPAR PRODUTO + FOCAR (UX PROFISSIONAL)
                // =====================================================
                function limparProdutoEFocar() {

                    $("#ProdutoID").val("");
                    $("#txtProduto").val("").removeData("estoque");
                    $("#PrecoUnitario").val("");
                    $("#Quantidade").val(1);

                    // 🔥 FOCO AUTOMÁTICO PARA PRÓXIMO ITEM
                    $("#txtProduto").focus();
                }

                // =====================================================
                // BOTÃO FINALIZAR VENDA (ABRE MODAL)
                // =====================================================
                $("#btnFinalizar").click(function () {

                    if (!$("#ClienteID").val()) {
                        alert("Selecione um cliente válido da lista.");
                        return;
                    }

                    if (!$("#VendedorID").val()) {
                        alert("Selecione um vendedor válido da lista.");
                        return;
                    }

                    if (itens.length === 0) {
                        alert("Adicione ao menos um produto.");
                        return;
                    }

                    // Atualiza o valor total no modal
                    $("#modalTotal").text($("#TotalVenda").text());
                    
                    $("#modalPagamento").modal("show");
                });

                // =====================================================
                // MOSTRA / ESCONDE PARCELAS
                // =====================================================
                $("#TipoPagamento").change(function () {

                    if ($(this).val() === "parcelado") {
                        gerarParcelas();
                        $("#areaParcelas").show();
                    } else {
                        $("#areaParcelas").hide();
                        $("#gridParcelas tbody").empty();
                    }
                });

                // =====================================================
                // GERAR PARCELAS AUTOMATICAMENTE
                // =====================================================
               function gerarParcelas() {
                    const qtd = +$("#NumeroParcelas").val();
                    const total = +$("#TotalVenda").text();
                    let data = new Date($("#DataPrimeiroVencimento").val());
                    const valor = (total / qtd).toFixed(2);
                    $("#gridParcelas tbody").empty();
                    for (let i = 1; i <= qtd; i++) {
                        $("#gridParcelas tbody").append(`<tr><td>${i}</td><td>${data.toISOString().split("T")[0]}</td><td class="text-end">R$ ${valor}</td></tr>`);
                        data.setMonth(data.getMonth()+1);
                    }
                }

                // =====================================================
                // CONFIRMAR PAGAMENTO (ENVIA PARA API)
                // =====================================================
                $("#btnConfirmarPagamento").click(function () {

                    if (!$("#FormaPgtoID").val()) {
                        alert("Selecione a forma de pagamento.");
                        return;
                    }

                    const venda = {
                        clienteID: parseInt($("#ClienteID").val()),
                        vendedorID: parseInt($("#VendedorID").val()),
                        formaPgtoID: parseInt($("#FormaPgtoID").val()),
                        observacoes: "Venda Web",
                        itens: itens.map(i => ({
                            produtoID: i.produtoId,
                            quantidade: i.quantidade,
                            precoUnitario: i.preco
                        })),
                        parcelas: []
                    };

                    if ($("#TipoPagamento").val() === "parcelado") {
                        $("#gridParcelas tbody tr").each(function () {
                            venda.parcelas.push({
                                numero: parseInt($(this).find("td:eq(0)").text()),
                                dataVencimento: $(this).find("td:eq(1)").text(),
                                valor: parseFloat($(this).find("td:eq(2)").text().replace('R$ ', ''))
                            });
                        });
                    }

                    $.ajax({
                        url: "/api/vendas/finalizar",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(venda),
                        success: function (res) {
                            alert("Venda realizada com sucesso! ID: " + res.vendaId);
                            location.reload();
                        },
                        error: function (xhr) {
                            console.error(xhr);
                            alert(
                                "ERRO AO FINALIZAR:\n\n" +
                                (xhr.responseJSON?.erro || xhr.responseText || "Erro desconhecido")
                            );
                        }
                    });
                });

                // =====================================================
                // CARREGA FORMAS DE PAGAMENTO
                // =====================================================
                $.getJSON("/api/formas-pagamento", function (data) {

                    const combo = $("#FormaPgtoID");
                    combo.empty();
                    combo.append('<option value="">Selecione...</option>');

                    data.forEach(f => {
                        combo.append(`<option value="${f.id}">${f.descricao}</option>`);
                    });
                });

                // Atualiza parcelas quando alterar número ou data
                $("#NumeroParcelas, #DataPrimeiroVencimento").on("change", function() {
                    if ($("#TipoPagamento").val() === "parcelado") {
                        gerarParcelas();
                    }
                });

                // Inicializar grid vazio
                atualizarGrid();

            });
        </script>
    }
</body>
</html>