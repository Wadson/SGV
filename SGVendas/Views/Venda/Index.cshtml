@{
    ViewData["Title"] = "Venda";
}

<h2>Nova Venda</h2>

<hr />

<!-- ========================================================= -->
<!-- CABEÇALHO DA VENDA -->
<!-- ========================================================= -->
<div class="row mb-3">

    <div class="col-md-4">
        <label>Vendedor</label>
        <input type="text" id="txtVendedor" class="form-control" placeholder="Buscar vendedor..." />
        <input type="hidden" id="VendedorID" />
    </div>

    <div class="col-md-4">
        <label>Cliente</label>
        <input type="text" id="txtCliente" class="form-control" placeholder="Buscar cliente..." />
        <input type="hidden" id="ClienteID" />
    </div>

    <div class="col-md-4">
        <label>Data da Venda</label>
        <input type="date"
               id="dataVenda"
               class="form-control"
               value="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

</div>

<hr />

<!-- ========================================================= -->
<!-- INCLUSÃO DE PRODUTOS -->
<!-- ========================================================= -->
<h4>Produtos</h4>

<div class="row mb-3">

    <div class="col-md-5">
        <label>Produto</label>
        <input type="text" id="txtProduto" class="form-control" placeholder="Buscar produto..." />
        <input type="hidden" id="ProdutoID" />
    </div>

    <div class="col-md-2">
        <label>Quantidade</label>
        <input type="number" id="Quantidade" class="form-control" value="1" min="1" />
    </div>

    <div class="col-md-3">
        <label>Preço Unitário</label>
        <input type="text" id="PrecoUnitario" class="form-control" readonly />
    </div>

    <div class="col-md-2">
        <label>&nbsp;</label>
        <button id="btnAdicionar" class="btn btn-success w-100">
            Adicionar
        </button>
    </div>

</div>

<hr />

<!-- ========================================================= -->
<!-- GRID DE ITENS DA VENDA -->
<!-- ========================================================= -->
<table class="table table-bordered" id="gridItens">
    <thead class="table-light">
        <tr>
            <th>Produto</th>
            <th style="width: 100px;">Qtd</th>
            <th style="width: 120px;">Preço</th>
            <th style="width: 120px;">Subtotal</th>
            <th style="width: 80px;">Ação</th>
        </tr>
    </thead>
    <tbody>
        <!-- Itens inseridos via JavaScript -->
    </tbody>
</table>

<hr />

<!-- ========================================================= -->
<!-- TOTAL DA VENDA -->
<!-- ========================================================= -->
<div class="row">
    <div class="col-md-4 offset-md-8 text-end">
        <h4>
            Total: R$
            <span id="TotalVenda">0,00</span>
        </h4>

        <button id="btnFinalizar" class="btn btn-primary mt-2">
            Finalizar Venda
        </button>
    </div>
</div>

<!-- ========================================================= -->
<!-- SCRIPTS -->
<!-- ========================================================= -->
@section Scripts {

    <!-- ========================= -->
    <!-- LIBRARIES -->
    <!-- ========================= -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link rel="stylesheet"
          href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- ========================= -->
    <!-- FIX Z-INDEX AUTOCOMPLETE -->
    <!-- ========================= -->
    <style>
        .ui-autocomplete {
            z-index: 1055 !important;
        }
    </style>

    <script>
        $(function () {

            // =====================================================
            // VARIÁVEL PRINCIPAL DA VENDA (FONTE DA VERDADE)
            // =====================================================
            let itens = [];

            // =====================================================
            // AUTOCOMPLETE CLIENTE
            // =====================================================
            $("#txtCliente").autocomplete({
                source: function (request, response) {
                    $.getJSON("/api/clientes/buscar", {
                        termo: request.term
                    }, response);
                },
                select: function (event, ui) {
                    $("#ClienteID").val(ui.item.id);
                },
                minLength: 2
            });

            // =====================================================
            // AUTOCOMPLETE VENDEDOR
            // =====================================================
            $("#txtVendedor").autocomplete({
                source: function (request, response) {
                    $.getJSON("/api/clientes/vendedores", {
                        termo: request.term
                    }, response);
                },
                select: function (event, ui) {
                    $("#VendedorID").val(ui.item.id);
                },
                minLength: 2
            });

            // =====================================================
            // AUTOCOMPLETE PRODUTO
            // =====================================================
            $("#txtProduto").autocomplete({
                source: function (request, response) {
                    $.getJSON("/api/produtos/buscar", {
                        termo: request.term
                    }, response);
                },
                select: function (event, ui) {

                    $("#ProdutoID").val(ui.item.id);
                    $("#txtProduto").val(ui.item.label);
                    $("#PrecoUnitario").val(ui.item.preco.toFixed(2));

                    // Guarda estoque no input
                    $("#txtProduto").data("estoque", ui.item.estoque);

                    return false;
                },
                minLength: 2
            });

            // =====================================================
            // ADICIONAR ITEM AO GRID
            // =====================================================
            $("#btnAdicionar").click(function () {

                const produtoId = parseInt($("#ProdutoID").val());
                const produtoNome = $("#txtProduto").val();
                const quantidade = parseInt($("#Quantidade").val());
                const preco = parseFloat($("#PrecoUnitario").val().replace(",", "."));
                const estoqueDisponivel = parseInt($("#txtProduto").data("estoque"));

                if (!produtoId || quantidade <= 0 || isNaN(preco)) {
                    alert("Informe um produto válido.");
                    return;
                }

                const itemExistente = itens.find(i => i.produtoId === produtoId);

                if (itemExistente) {

                    if (itemExistente.quantidade + quantidade > itemExistente.estoque) {
                        alert("Estoque insuficiente.");
                        return;
                    }

                    itemExistente.quantidade += quantidade;
                    itemExistente.subtotal = itemExistente.quantidade * itemExistente.preco;

                } else {

                    if (quantidade > estoqueDisponivel) {
                        alert("Estoque insuficiente.");
                        return;
                    }

                    itens.push({
                        produtoId,
                        produtoNome,
                        quantidade,
                        preco,
                        estoque: estoqueDisponivel,
                        subtotal: quantidade * preco
                    });
                }

                atualizarGrid();
                limparProduto();
            });

            // =====================================================
            // ATUALIZAR GRID E TOTAL
            // =====================================================
            function atualizarGrid() {

                const tbody = $("#gridItens tbody");
                tbody.empty();

                let total = 0;

                itens.forEach((item, index) => {

                    total += item.subtotal;

                    tbody.append(`
                        <tr>
                            <td>${item.produtoNome}</td>
                            <td>${item.quantidade}</td>
                            <td>R$ ${item.preco.toFixed(2)}</td>
                            <td>R$ ${item.subtotal.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                    onclick="removerItem(${index})">X</button>
                            </td>
                        </tr>
                    `);
                });

                $("#TotalVenda").text(total.toFixed(2));
            }

            // =====================================================
            // REMOVER ITEM
            // =====================================================
            window.removerItem = function (index) {
                itens.splice(index, 1);
                atualizarGrid();
            };

            // =====================================================
            // LIMPAR CAMPOS DO PRODUTO
            // =====================================================
            function limparProduto() {
                $("#ProdutoID").val("");
                $("#txtProduto").val("").removeData("estoque");
                $("#Quantidade").val(1);
                $("#PrecoUnitario").val("");
            }

        });



                // =====================================================
        // FINALIZAR VENDA
        // =====================================================
        $("#btnFinalizar").click(function () {

            if (itens.length === 0) {
                alert("Adicione ao menos um produto.");
                return;
            }

            const venda = {
                clienteID: parseInt($("#ClienteID").val()),
                vendedorID: parseInt($("#VendedorID").val()),
                formaPgtoID: null,
                observacoes: null,
                itens: itens.map(i => ({
                    produtoID: i.produtoId,
                    quantidade: i.quantidade,
                    precoUnitario: i.preco
                }))
            };

            $.ajax({
                url: "/api/vendas/finalizar",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(venda),
                success: function (res) {
                    alert("Venda realizada com sucesso! Nº " + res.vendaId);
                    location.reload();
                },
                error: function (err) {
                    alert("Erro ao finalizar venda.");
                }
            });
        });







    </script>
}
