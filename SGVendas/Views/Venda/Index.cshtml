@{
    ViewData["Title"] = "Nova Venda";
    Layout = "_LayoutSistema";
}

<h3 class="mb-3">💰 Nova Venda</h3>

<!-- ================= DADOS DA VENDA ================= -->
<div class="card mb-3">
    <div class="card-header bg-light"><strong>Dados da Venda</strong></div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label>Vendedor</label>
                <input type="text" id="txtVendedor" class="form-control">
                <input type="hidden" id="VendedorID">
            </div>

            <div class="col-md-4">
                <label>Cliente</label>
                <input type="text" id="txtCliente" class="form-control">
                <input type="hidden" id="ClienteID">
            </div>

            <div class="col-md-4">
                <label>Data</label>
                <input type="date" id="dataVenda" class="form-control"
                       value="@DateTime.Now.ToString("yyyy-MM-dd")">
            </div>
        </div>
    </div>
</div>

<!-- ================= PRODUTOS ================= -->
<div class="card mb-3">
    <div class="card-header bg-light"><strong>Adicionar Produto</strong></div>
    <div class="card-body">
        <div class="row align-items-end">

            <div class="col-md-5">
                <label>Produto</label>
                <input type="text" id="txtProduto" class="form-control">
                <input type="hidden" id="ProdutoID">
            </div>

            <div class="col-md-2">
                <label>Qtd</label>
                <input type="number" id="Quantidade" class="form-control" value="1">
            </div>

            <div class="col-md-3">
                <label>Preço</label>
                <input type="number" id="PrecoUnitario" class="form-control">
            </div>

            <div class="col-md-2">
                <button id="btnAdicionar" class="btn btn-success w-100">Adicionar</button>
            </div>

        </div>
    </div>
</div>

<!-- ================= ITENS ================= -->
<table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>Produto</th>
            <th width="80">Qtd</th>
            <th width="120">Preço</th>
            <th width="120">Subtotal</th>
            <th width="60"></th>
        </tr>
    </thead>
    <tbody id="gridItens"></tbody>
</table>

<!-- ================= TOTAL ================= -->
<div class="card border-success">
    <div class="card-body text-end">
        <h3 class="text-success">
            Total: R$ <span id="TotalVenda">0,00</span>
        </h3>
        <button id="btnFinalizar" class="btn btn-success btn-lg mt-2">
            Finalizar Venda
        </button>
    </div>
</div>

<!-- ================= MODAL PAGAMENTO ================= -->
<div class="modal fade" id="modalPagamento">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Pagamento</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>Forma de Pagamento</label>
                        <select id="FormaPgtoID" class="form-control"></select>
                    </div>

                    <div class="col-md-6">
                        <label>Tipo</label>
                        <select id="TipoPagamento" class="form-control">
                            <option value="avista">À Vista</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>
                </div>

                <div id="areaParcelas" style="display:none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Nº Parcelas</label>
                            <input type="number" id="NumeroParcelas" class="form-control" value="1">
                        </div>
                        <div class="col-md-6">
                            <label>1º Vencimento</label>
                            <input type="date" id="DataPrimeiroVencimento" class="form-control"
                                   value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")">
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>#</th><th>Vencimento</th><th>Valor</th></tr>
                        </thead>
                        <tbody id="gridParcelas"></tbody>
                    </table>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarPagamento" class="btn btn-success">
                    Confirmar
                </button>
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <script>
        // =============================
        // SCRIPT FINAL DA VENDA
        // =============================

        let itens = [];

        $(function () {

            // AUTOCOMPLETE CLIENTE
            $("#txtCliente").autocomplete({
                source: (r, s) =>
                    $.getJSON("/api/clientes/buscar", { termo: r.term }, s),
                select: (e, ui) => {
                    $("#ClienteID").val(ui.item.id);
                    return false;
                },
                minLength: 2
            });

            // AUTOCOMPLETE VENDEDOR
            $("#txtVendedor").autocomplete({
                source: (r, s) =>
                    $.getJSON("/api/clientes/vendedores", { termo: r.term }, s),
                select: (e, ui) => {
                    $("#VendedorID").val(ui.item.id);
                },
                minLength: 2
            });

            // AUTOCOMPLETE PRODUTO
            $("#txtProduto").autocomplete({
                source: (r, s) =>
                    $.getJSON("/api/produtos/buscar", { termo: r.term }, s),
                select: (e, ui) => {
                    $("#ProdutoID").val(ui.item.id);
                    $("#PrecoUnitario").val(ui.item.preco.toFixed(2));
                    $("#txtProduto").data("estoque", ui.item.estoque);
                    return false;
                },
                minLength: 2
            });

            // ADICIONAR ITEM
            $("#btnAdicionar").click(function () {

                const produtoId = +$("#ProdutoID").val();
                const nome = $("#txtProduto").val();
                const qtd = +$("#Quantidade").val();
                const preco = +$("#PrecoUnitario").val();

                if (!produtoId || qtd <= 0 || preco <= 0) {
                    alert("Produto inválido.");
                    return;
                }

                const existente = itens.find(i => i.produtoId === produtoId);

                if (existente) {
                    existente.quantidade += qtd;
                    existente.subtotal = existente.quantidade * existente.preco;
                } else {
                    itens.push({
                        produtoId,
                        nome,
                        quantidade: qtd,
                        preco,
                        subtotal: qtd * preco
                    });
                }

                atualizarGrid();
            });

            function atualizarGrid() {
                let total = 0;

                $("#gridItens").html(itens.map((i, idx) => {
                    total += i.subtotal;
                    return `
                        <tr>
                            <td>${i.nome}</td>
                            <td>${i.quantidade}</td>
                            <td>R$ ${i.preco.toFixed(2)}</td>
                            <td>R$ ${i.subtotal.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                    onclick="removerItem(${idx})">X</button>
                            </td>
                        </tr>`;
                }));

                $("#TotalVenda").text(total.toFixed(2));
            }

            window.removerItem = function (idx) {
                itens.splice(idx, 1);
                atualizarGrid();
            };

            // FINALIZAR VENDA
            $("#btnFinalizar").click(function () {
                $("#modalPagamento").modal("show");
            });

        });
    </script>
}
