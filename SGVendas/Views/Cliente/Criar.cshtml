@model SGVendas.Domain.Entities.Cliente

@{
    ViewData["Title"] = "Novo Cliente";
}

<h2>Cadastro de Cliente</h2>

<form asp-action="@(Model.ClienteID == 0 ? "Criar" : "Editar")" method="post">
    
    <!-- ID OCULTO (ESSENCIAL PARA EDIÇÃO) -->
    <input type="hidden" asp-for="ClienteID" />


    <!-- IDENTIFICAÇÃO (OBRIGATÓRIO) -->
    <fieldset class="border p-3 mb-3">
        <legend>Identificação</legend>

        <div class="form-group">
            <label>Nome / Razão Social</label>
            <input asp-for="Nome" class="form-control" />
            <span asp-validation-for="Nome" class="text-danger"></span>
        </div>
    </fieldset>



    <!-- TIPO DE PESSOA -->
    <fieldset class="border p-3 mb-3">
        <legend>Tipo de Pessoa</legend>

        <div class="form-group">
            <label>Tipo</label>
            <select asp-for="TipoCliente" id="TipoCliente" class="form-control">
                <option value="">Selecione</option>
                <option value="FISICA">Pessoa Física</option>
                <option value="JURIDICA">Pessoa Jurídica</option>
            </select>
        </div>
    </fieldset>

    <!-- PESSOA FÍSICA -->
    <fieldset id="PessoaFisica" class="border p-3 mb-3" style="display:none">
        <legend>Pessoa Física</legend>

        <div class="form-group">
            <label>CPF</label>
            <input asp-for="Cpf" class="form-control" maxlength="11" />            
        </div>

        <div class="form-group">
            <label>RG</label>
            <input asp-for="RG" class="form-control" />
        </div>

        <div class="form-group">
            <label>Órgão Expedidor</label>
            <input asp-for="OrgaoExpedidorRG" class="form-control" />
        </div>

        <div class="form-group">
            <label>Data de Nascimento</label>
            <input asp-for="DataNascimento" type="date" class="form-control" />
        </div>
    </fieldset>

    <!-- PESSOA JURÍDICA -->
    <fieldset id="PessoaJuridica" class="border p-3 mb-3" style="display:none">
        <legend>Pessoa Jurídica</legend>

        <div class="form-group">
            <label>CNPJ</label>
            <input asp-for="Cnpj" class="form-control" maxlength="14" />
        </div>

        <div class="form-group">
            <label>Inscrição Estadual</label>
            <input asp-for="IE" class="form-control" />
        </div>
    </fieldset>

    <!-- CONTATO -->
    <fieldset class="border p-3 mb-3">
        <legend>Contato</legend>

        <div class="form-group">
            <label>Telefone</label>
            <input asp-for="Telefone" class="form-control" />
        </div>

        <div class="form-group">
            <label>Email</label>
            <input asp-for="Email" class="form-control" />
        </div>
    </fieldset>

    <!-- ENDEREÇO -->
    <fieldset class="border p-3 mb-3">
        <legend>Endereço</legend>

        <div class="form-group">
            <label>CEP</label>
            <input asp-for="Cep" id="Cep" class="form-control" />
        </div>

        <div class="form-group">
            <label>Logradouro</label>
            <input asp-for="Logradouro" id="Logradouro" class="form-control" />
        </div>

        <div class="form-group">
            <label>Número</label>
            <input asp-for="Numero" class="form-control" />
        </div>

        <div class="form-group">
            <label>Bairro</label>
            <input asp-for="Bairro" id="Bairro" class="form-control" />
        </div>

        <div class="form-group">
            <label>Cidade</label>
            <select asp-for="CidadeID" id="CidadeID" class="form-control">
                <option value="">Selecione</option>
            </select>
        </div>
    </fieldset>

    <!-- OUTROS -->
    <fieldset class="border p-3 mb-3">
        <legend>Outros</legend>

        <div class="form-group">
            <label>Limite de Crédito</label>
            <input asp-for="LimiteCredito" class="form-control" />
        </div>

        <div class="form-group">
            <label>Observações</label>
            <textarea asp-for="Observacoes" class="form-control"></textarea>
        </div>

        <div class="form-check">
            <input asp-for="IsVendedor" class="form-check-input" />
            <label class="form-check-label">É vendedor</label>
        </div>
    </fieldset>

    <!-- BOTÕES -->
    <button type="submit" class="btn btn-success">Salvar</button>
    <a asp-action="Index" class="btn btn-secondary">Cancelar</a>

</form>








@section Scripts {
    <script>
        // Alterna PF / PJ
        document.getElementById('TipoCliente').addEventListener('change', function () {
            document.getElementById('PessoaFisica').style.display =
                this.value === 'FISICA' ? 'block' : 'none';

            document.getElementById('PessoaJuridica').style.display =
                this.value === 'JURIDICA' ? 'block' : 'none';
        });

        // Busca CEP
        document.getElementById("Cep").addEventListener("blur", function () {

            const cep = this.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(r => r.json())
                .then(d => {
                    if (d.erro) return;

                    document.getElementById("Logradouro").value = d.logradouro;
                    document.getElementById("Bairro").value = d.bairro;

                    fetch(`/api/cidades/buscar?nome=${d.localidade}&uf=${d.uf}`)
                        .then(r => r.json())
                        .then(cidade => {
                            const select = document.getElementById("CidadeID");
                            select.innerHTML =
                                `<option value="${cidade.id}">${cidade.nome}</option>`;
                        });
                });
        });
    </script>
}
