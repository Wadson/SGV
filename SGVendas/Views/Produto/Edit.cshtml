@model SGVendas.Application.DTOs.ProdutoDto

@{
    ViewData["Title"] = "Editar Produto";
}

<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .form-card {
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: none;
    }

    .form-header {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

        .form-section h5 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
        }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.75rem;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

        .form-control:focus, .form-select:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
        }

    .currency-input {
        position: relative;
    }

        .currency-input .input-group-text {
            background-color: #f8f9fa;
            border-right: none;
        }

        .currency-input .form-control {
            border-left: none;
            padding-left: 0;
        }

    .status-badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.75rem;
    }

    .btn-action {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 6px;
        min-width: 120px;
    }

    .btn-save {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        border: none;
    }

        .btn-save:hover {
            background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }

    .btn-cancel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
    }

        .btn-cancel:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

    .required-field::after {
        content: " *";
        color: #dc3545;
    }

    .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .field-validation-error {
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
    }

    .input-validation-error {
        border-color: #dc3545;
    }

        .input-validation-error:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
</style>

<div class="container-fluid py-4">
    <div class="form-container">
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold text-primary mb-1">Editar Produto</h1>
                <p class="text-muted mb-0">Atualize as informações do produto</p>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-3 px-3 py-2">
                    <i class="bi bi-tag me-2"></i>Código: #@Model.ProdutoID
                </span>
            </div>
        </div>

        <form asp-action="Edit" method="post" class="form-card card p-4">
            <input type="hidden" asp-for="ProdutoID" />

            <!-- Seção Informações Básicas -->
            <div class="form-section">
                <h5><i class="bi bi-info-circle me-2"></i>Informações Básicas</h5>

                <div class="row g-3">
                    <div class="col-md-8">
                        <label asp-for="NomeProduto" class="form-label required-field">Nome do Produto</label>
                        <input asp-for="NomeProduto" class="form-control" placeholder="Digite o nome do produto" />
                        <span asp-validation-for="NomeProduto" class="field-validation-error"></span>
                        <div class="help-text">Nome completo do produto para identificação</div>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="Referencia" class="form-label">Referência</label>
                        <input asp-for="Referencia" class="form-control" placeholder="Ex: REF-001" />
                        <div class="help-text">Código interno de referência</div>
                    </div>
                </div>
            </div>

            <!-- Seção Preço e Estoque -->
            <div class="form-section">
                <h5><i class="bi bi-currency-dollar me-2"></i>Preço e Estoque</h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="PrecoDeVenda" class="form-label required-field">Preço de Venda</label>
                        <div class="currency-input input-group">
                            <span class="input-group-text">R$</span>
                            <input asp-for="PrecoDeVenda" class="form-control" type="number" step="0.01" min="0" placeholder="0,00" />
                        </div>
                        <span asp-validation-for="PrecoDeVenda" class="field-validation-error"></span>
                        <div class="help-text">Preço unitário de venda ao cliente</div>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Estoque" class="form-label required-field">Estoque Disponível</label>
                        <div class="input-group">
                            <input asp-for="Estoque" class="form-control" type="number" min="0" placeholder="Quantidade em estoque" />
                            <span class="input-group-text">unidades</span>
                        </div>
                        <span asp-validation-for="Estoque" class="field-validation-error"></span>
                        <div class="help-text">Quantidade atual disponível para venda</div>

                        <!-- Indicador visual de estoque -->
                        <div class="mt-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Baixo</small>
                                <small>Alto</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                @{
                                    var estoquePercent = Model.Estoque > 100 ? 100 : Model.Estoque;
                                    var estoqueClass = Model.Estoque < 20 ? "bg-danger" : Model.Estoque < 50 ? "bg-warning" : "bg-success";
                                }
                                <div class="progress-bar @estoqueClass" style="width: @estoquePercent%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Status -->
            <div class="form-section">
                <h5><i class="bi bi-toggle-on me-2"></i>Status do Produto</h5>

                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label asp-for="Status" class="form-label required-field">Status</label>
                        <select asp-for="Status" class="form-select">
                            <option value="">Selecione um status</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                            <option value="Esgotado">Esgotado</option>
                            <option value="Descontinuado">Descontinuado</option>
                        </select>
                        <span asp-validation-for="Status" class="field-validation-error"></span>
                    </div>

                    <div class="col-md-6">
                        <div class="d-flex align-items-center h-100">
                            @{
                                var statusBadgeClass = Model.Status == "Ativo" ? "bg-success" :
                                Model.Status == "Inativo" ? "bg-danger" :
                                Model.Status == "Esgotado" ? "bg-warning" :
                                "bg-secondary";
                            }
                            <span class="badge @statusBadgeClass status-badge me-3">
                                <i class="bi bi-circle-fill me-1"></i>@(Model.Status ?? "Não definido")
                            </span>
                            <div class="help-text">Status atual do produto no sistema</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informações do Sistema -->
            <div class="alert alert-light border mb-4">
                <div class="d-flex">
                    <i class="bi bi-info-circle text-primary me-2 mt-1"></i>
                    <div>
                        <small class="text-muted">
                            <strong>Informações do sistema:</strong>
                            Última atualização: @DateTime.Now.ToString("dd/MM/yyyy HH:mm") |
                            Usuário: @User.Identity?.Name
                        </small>
                    </div>
                </div>
            </div>

            <!-- Ações do Formulário -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                <div>
                    <a asp-action="Index" class="btn btn-cancel btn-action">
                        <i class="bi bi-arrow-left me-2"></i>Voltar
                    </a>
                </div>

                <div class="d-flex gap-3">
                    <button type="reset" class="btn btn-cancel btn-action">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-save btn-action">
                        <i class="bi bi-check-circle me-2"></i>Salvar Alterações
                    </button>
                </div>
            </div>
        </form>

        <!-- Card de ajuda rápida -->
        <div class="card border-0 bg-light mt-4">
            <div class="card-body p-3">
                <div class="d-flex">
                    <i class="bi bi-lightbulb text-warning me-3 fs-5"></i>
                    <div>
                        <small class="text-muted">
                            <strong>Dica:</strong> Verifique se todas as informações estão corretas antes de salvar.
                            Alterações no preço e status afetam diretamente as vendas.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Formatação do campo de preço
            const precoInput = document.querySelector('input[name="PrecoDeVenda"]');
            precoInput.addEventListener('blur', function() {
                let value = parseFloat(this.value);
                if (!isNaN(value)) {
                    this.value = value.toFixed(2);
                }
            });

            // Validação em tempo real para estoque
            const estoqueInput = document.querySelector('input[name="Estoque"]');
            estoqueInput.addEventListener('input', function() {
                let value = parseInt(this.value);
                if (isNaN(value)) value = 0;

                // Atualiza a barra de progresso
                const progressBar = document.querySelector('.progress-bar');
                let percent = value > 100 ? 100 : value;
                progressBar.style.width = percent + '%';

                // Atualiza a classe da barra
                progressBar.className = 'progress-bar ';
                if (value < 20) progressBar.classList.add('bg-danger');
                else if (value < 50) progressBar.classList.add('bg-warning');
                else progressBar.classList.add('bg-success');
            });

            // Atualiza badge de status quando selecionado
            const statusSelect = document.querySelector('select[name="Status"]');
            const statusBadge = document.querySelector('.status-badge');
            const statusIcon = statusBadge.querySelector('i');

            statusSelect.addEventListener('change', function() {
                const status = this.value;
                statusBadge.textContent = status;
                statusBadge.className = 'badge status-badge me-3 ';

                switch(status) {
                    case 'Ativo':
                        statusBadge.classList.add('bg-success');
                        break;
                    case 'Inativo':
                        statusBadge.classList.add('bg-danger');
                        break;
                    case 'Esgotado':
                        statusBadge.classList.add('bg-warning');
                        break;
                    default:
                        statusBadge.classList.add('bg-secondary');
                }

                // Mantém o ícone
                statusBadge.innerHTML = '<i class="bi bi-circle-fill me-1"></i>' + status;
            });

            // Previne envio do formulário com Enter em campos indesejados
            document.querySelectorAll('input, select').forEach(function(input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.type !== 'submit' && this.type !== 'button') {
                        e.preventDefault();
                    }
                });
            });

            // Foco automático no primeiro campo
            document.querySelector('input[name="NomeProduto"]').focus();
        });

               // ===============================
        // CONTROLE DE SAÍDA COM ALTERAÇÕES
        // ===============================
        let formAlterado = false;

        const form = document.querySelector('form');

        // Marca o formulário como alterado ao mudar qualquer campo
        form.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => {
                formAlterado = true;
            });
        });

        // Ao enviar (Salvar), desativa o aviso
        form.addEventListener('submit', () => {
            formAlterado = false;
        });
                // ===============================
        // CONFIRMAÇÃO VISUAL APÓS SALVAR
        // ===============================
        form.addEventListener('submit', function () {
            // Pequeno delay para evitar conflito com redirect
            setTimeout(() => {
                sessionStorage.setItem('produtoSalvo', '1');
            }, 100);
        });

        // Exibe mensagem ao voltar para Index
        if (sessionStorage.getItem('produtoSalvo') === '1') {
            sessionStorage.removeItem('produtoSalvo');
            alert('✅ Produto salvo com sucesso!');
        }




        // Exibe aviso somente se houve alteração
        window.addEventListener('beforeunload', function (e) {
            if (!formAlterado) return;
            e.preventDefault();
            e.returnValue = '';
        });

    </script>
}