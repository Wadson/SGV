@{
    ViewData["Title"] = "Produtos";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Produtos</h2>

        
        <a href="/ProdutoView/Novo" class="btn btn-primary">

            <i class="bi bi-plus-circle"></i> Novo Produto
        </a>
    </div>

    <!-- Campo de busca -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <input type="text"
                       id="txtBusca"
                       class="form-control"
                       placeholder="Buscar produto..." />

                <button class="btn btn-outline-primary"
                        type="button"
                        onclick="buscarProdutos()">
                    <i class="bi bi-search"></i>
                </button>
            </div>


        </div>
    </div>

    <!-- Tabela -->
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Código</th>
                <th>Produto</th>
                <th>Preço</th>
                <th>Estoque<th>
                <th style="width:140px">Ações</th>
            </tr>
        </thead>
        <tbody id="tbodyProdutos">
            <tr>
                <td colspan="4" class="text-center text-muted">
                    Carregando produtos...
                </td>
            </tr>
        </tbody>
    </table>

</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            carregarProdutos();
        });

        function carregarProdutos() {
            fetch('/api/produto')
                .then(response => {
                    if (!response.ok)
                        throw new Error('Erro ao carregar produtos');
                    return response.json();
                })
                .then(data => montarTabela(data))
                .catch(err => {
                    console.error(err);
                    document.getElementById('tbodyProdutos').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-danger text-center">
                                Erro ao carregar produtos
                            </td>
                        </tr>`;
                });
        }

        // 🧱 MONTA A TABELA (PADRÃO API /api/produtos)
        function montarTabela(produtos) {
            const tbody = document.getElementById('tbodyProdutos');
            tbody.innerHTML = '';

            if (!produtos || produtos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            Nenhum produto encontrado
                        </td>
                    </tr>`;
                return;
            }

                 produtos.forEach(p => { tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.label}</td>
                    <td>${p.referencia ?? ''}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td>${p.estoque}</td>
                    <td>${p.status}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning me-1"
                                onclick="editarProduto(${p.id})">
                            ✏️
                        </button>

                        <button class="btn btn-sm btn-danger"
                                onclick="excluirProduto(${p.id})">
                            🗑️
                        </button>
                    </td>
                </tr>            `;
        });

        }


        <!-- 🧱 FUNÇÃO DE BUSCA -->
              document.addEventListener('DOMContentLoaded', function () {
            carregarProdutos();
        });

        function carregarProdutos() {
            fetch('/api/produto')
                .then(r => r.json())
                .then(data => montarTabela(data));
        }

        function buscarProdutos() 
        {
            const termo = document.getElementById('txtBusca').value.trim();

            // Se vazio, volta a listar tudo
            if (termo === '') {
                carregarProdutos();
                return;
            }

            fetch(`/api/produto/pesquisar?termo=${encodeURIComponent(termo)}`)
                .then(r => r.json())
                .then(data => montarTabela(data))
                .catch(() => {
                    document.getElementById('tbodyProdutos').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                Erro ao pesquisar produtos
                            </td>
                        </tr>`;
                });
        }
                function editarProduto(id) { window.location.href = `/ProdutoView/Editar/${id}`; // <-- COLOQUE AQUI
        }
                function excluirProduto(id) 
                {
                    if (!confirm('Deseja realmente inativar este produto?'))
                        return;

                    fetch(`/api/produto/${id}`, {
                        method: 'DELETE'
                    })
                    .then(r => {
                        if (!r.ok) throw new Error();
                        buscarProdutos(); // Atualiza a lista após inativar
                    })
                    .catch(() => alert('Erro ao inativar produto'));
        }


    </script>
      
    
}





